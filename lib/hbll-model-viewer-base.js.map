{"version":3,"file":"hbll-model-viewer-base.js","sourceRoot":"","sources":["../src/hbll-model-viewer-base.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, LitElement, property, css, query } from \"lit-element\";\r\nimport { urlFromUnzippedFile, jsonFromFile } from \"./file-utils.js\";\r\n\r\nconst map_style = {\r\n  height: \"100vh\",\r\n  width: \"100%\",\r\n};\r\n\r\nexport default class HbllModelViewerElementBase extends LitElement {\r\n  @query(\"model-viewer\") readonly modelViewer?: any;\r\n  @query(\"a\") readonly downloader?: any;\r\n  @property({ type: String }) src: string | null = null;\r\n  @property({ type: String }) skybox_image: string | null = null;\r\n  @property() annotations: any | null = null;\r\n\r\n  cameraIsDirty: boolean;\r\n  hotspots: any[];\r\n\r\n  constructor() {\r\n    super();\r\n    this.cameraIsDirty = false;\r\n    this.hotspots = [];\r\n  }\r\n\r\n  async firstUpdated() {\r\n    // Give the browser a chance to paint\r\n    await new Promise((r) => setTimeout(r, 0));\r\n    console.log(\"First updated\");\r\n    this.addEventListener(\"drop\", this.onDrop);\r\n    this.addEventListener(\"dragover\", this.onDragover);\r\n  }\r\n\r\n  private onDragover(event: DragEvent) {\r\n    if (!event.dataTransfer) return;\r\n\r\n    event.stopPropagation();\r\n    event.preventDefault();\r\n  }\r\n\r\n  private async onDrop(event: DragEvent) {\r\n    console.log(event);\r\n    event.stopPropagation();\r\n    event.preventDefault();\r\n\r\n    if (event.dataTransfer && event.dataTransfer.items[0].kind === \"file\") {\r\n      const file = event.dataTransfer.items[0].getAsFile();\r\n      if (!file) return;\r\n      if (file.name.match(/\\.(glb)$/i)) {\r\n        this.src = await urlFromUnzippedFile(file);\r\n      }\r\n      if (file.name.match(/\\.(hdr|png|jpg|jpeg)$/i)) {\r\n        this.skybox_image = await urlFromUnzippedFile(file);\r\n      }\r\n      if (file.name.match(/\\.(json)$/i)) {\r\n        this.annotations = await jsonFromFile(file);\r\n      }\r\n      if (file.name.match(/\\.(zip)$/i)) {\r\n        console.log(\"Dropped a zipped file\");\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleClick(event: MouseEvent) {\r\n    if (!this.cameraIsDirty) {\r\n      if (!this.modelViewer) {\r\n        throw new Error(\"Model Viewer doesn't exist\");\r\n      }\r\n      const rect = this.modelViewer.getBoundingClientRect();\r\n      const x = event.clientX - rect.left;\r\n      const y = event.clientY - rect.top;\r\n      const positionAndNormal = this.modelViewer.positionAndNormalFromPoint(\r\n        x,\r\n        y\r\n      );\r\n      console.log(positionAndNormal);\r\n      this.hotspots.push(positionAndNormal);\r\n      this.requestUpdate();\r\n      if (!positionAndNormal) {\r\n        throw new Error(\"invalid click position\");\r\n      }\r\n    } else this.cameraIsDirty = false;\r\n  }\r\n\r\n  private cameraMoved() {\r\n    this.cameraIsDirty = true;\r\n  }\r\n\r\n  private saveAnnotations() {\r\n    let blob = new Blob([JSON.stringify(this.hotspots)], {\r\n        type: \"text/plain;charset=utf-8\",\r\n      }),\r\n      url = window.URL.createObjectURL(blob);\r\n    this.downloader.href = url;\r\n    this.downloader.download = \"annotations.txt\";\r\n    this.downloader.click();\r\n    window.URL.revokeObjectURL(url);\r\n  }\r\n\r\n  static get styles() {\r\n    return css`\r\n      model-viewer {\r\n        width: 100%;\r\n        height: 100vh;\r\n      }\r\n\r\n      button {\r\n        display: block;\r\n        width: 20px;\r\n        height: 20px;\r\n        border-radius: 10px;\r\n        border: none;\r\n        background-color: blue;\r\n        box-sizing: border-box;\r\n      }\r\n\r\n      button[slot=\"hotspot-hand\"] {\r\n        --min-hotspot-opacity: 0;\r\n        background-color: red;\r\n      }\r\n\r\n      button[slot=\"hotspot-foot\"]:not([data-visible]) {\r\n        background-color: transparent;\r\n        border: 3px solid blue;\r\n      }\r\n\r\n      #annotation {\r\n        background-color: #888888;\r\n        position: absolute;\r\n        transform: translate(10px, 10px);\r\n        border-radius: 10px;\r\n        padding: 10px;\r\n      }\r\n      /* This keeps child nodes hidden while the element loads */\r\n      :not(:defined) > * {\r\n        display: none;\r\n      }\r\n\r\n      .download {\r\n        display: none;\r\n      }\r\n    `;\r\n  }\r\n\r\n  render() {\r\n    return html`\r\n      <a id=\"download\"></a>\r\n      <model-viewer\r\n        style=${map_style}\r\n        src=${this.src || \"\"}\r\n        skybox-image=${this.skybox_image || \"\"}\r\n        camera-controls\r\n        @click=\"${this.handleClick},\"\r\n        @camera-change=${this.cameraMoved}\r\n      >\r\n        <button @click=${this.saveAnnotations}>\r\n          <div id=\"annotation\">Save annotations</div>\r\n        </button>\r\n        ${this.hotspots.map(\r\n          (i) =>\r\n            html`<button\r\n              slot=\"hotspot-${i.position.x}-${i.position.y}-${i.position.z}\"\r\n              data-position=\"${i.position.x} ${i.position.y} ${i.position.z}\"\r\n              data-normal=\"${i.normal.x} ${i.normal.y} ${i.normal.z}\"\r\n            ></button>`\r\n        )}\r\n      </model-viewer>\r\n    `;\r\n  }\r\n}\r\n"]}