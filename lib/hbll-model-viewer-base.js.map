{"version":3,"file":"hbll-model-viewer-base.js","sourceRoot":"","sources":["../src/hbll-model-viewer-base.ts"],"names":[],"mappings":"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","sourcesContent":["import { html, LitElement, property, css, query } from \"lit-element\";\r\nimport { urlFromUnzippedFile, jsonFromFile } from \"./file-utils.js\";\r\nimport { AnnotationData, Annotation } from \"./types/annotations.js\";\r\n\r\nconst map_style = {\r\n  height: \"100vh\",\r\n  width: \"100%\",\r\n};\r\n\r\nexport default class HbllModelViewerElementBase extends LitElement {\r\n  @query(\"model-viewer\") readonly modelViewer?: any;\r\n  @query(\"a\") readonly downloader?: any;\r\n  @property({ type: String }) src: string | null = null;\r\n  @property({ type: String }) skybox_image: string | null = null;\r\n  @property() annotations: AnnotationData | null = null;\r\n\r\n  cameraIsDirty: boolean;\r\n  currentAnnotation: Annotation | undefined;\r\n  buttonStyles: any;\r\n\r\n  constructor() {\r\n    super();\r\n    this.cameraIsDirty = false;\r\n    this.currentAnnotation = undefined;\r\n  }\r\n\r\n  async firstUpdated() {\r\n    // Give the browser a chance to paint\r\n    await new Promise((r) => setTimeout(r, 0));\r\n    console.log(\"First updated\");\r\n    this.addEventListener(\"drop\", this.onDrop);\r\n    this.addEventListener(\"dragover\", this.onDragover);\r\n  }\r\n\r\n  private onDragover(event: DragEvent) {\r\n    if (!event.dataTransfer) return;\r\n\r\n    event.stopPropagation();\r\n    event.preventDefault();\r\n  }\r\n\r\n  private async onDrop(event: DragEvent) {\r\n    console.log(event);\r\n    event.stopPropagation();\r\n    event.preventDefault();\r\n\r\n    if (event.dataTransfer && event.dataTransfer.items[0].kind === \"file\") {\r\n      const file = event.dataTransfer.items[0].getAsFile();\r\n      if (!file) return;\r\n      if (file.name.match(/\\.(glb)$/i)) {\r\n        this.src = await urlFromUnzippedFile(file);\r\n      }\r\n      if (file.name.match(/\\.(hdr|png|jpg|jpeg)$/i)) {\r\n        this.skybox_image = await urlFromUnzippedFile(file);\r\n      }\r\n      if (file.name.match(/\\.(json)$/i)) {\r\n        this.annotations = await jsonFromFile(file);\r\n        console.log(this.annotations);\r\n        // this.annotations = await jsonFromFile(file);\r\n      }\r\n      if (file.name.match(/\\.(zip)$/i)) {\r\n        console.log(\"Dropped a zipped file\");\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleClick(event: MouseEvent) {\r\n    if (!this.cameraIsDirty) {\r\n      if (!this.modelViewer) {\r\n        throw new Error(\"Model Viewer doesn't exist\");\r\n      }\r\n      const rect = this.modelViewer.getBoundingClientRect();\r\n      const x = event.clientX - rect.left;\r\n      const y = event.clientY - rect.top;\r\n      const positionAndNormal = this.modelViewer.positionAndNormalFromPoint(\r\n        x,\r\n        y\r\n      );\r\n      console.log(positionAndNormal);\r\n      this.requestUpdate();\r\n      if (!positionAndNormal) {\r\n        throw new Error(\"invalid click position\");\r\n      }\r\n    } else this.cameraIsDirty = false;\r\n  }\r\n\r\n  private cameraMoved() {\r\n    this.cameraIsDirty = true;\r\n  }\r\n\r\n  private saveAnnotations() {\r\n    let blob = new Blob([JSON.stringify(this.annotations)], {\r\n        type: \"text/plain;charset=utf-8\",\r\n      }),\r\n      url = window.URL.createObjectURL(blob);\r\n    this.downloader.href = url;\r\n    this.downloader.download = \"annotations.json\";\r\n    this.downloader.click();\r\n    window.URL.revokeObjectURL(url);\r\n  }\r\n\r\n  private annotationClick(annotation: Annotation) {\r\n    this.currentAnnotation = annotation;\r\n    this.requestUpdate();\r\n  }\r\n\r\n  static get styles() {\r\n    return css`\r\n      model-viewer {\r\n        width: 100%;\r\n        height: 100vh;\r\n      }\r\n      button {\r\n        background: #fff;\r\n        border-radius: 32px;\r\n        border: 0;\r\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);\r\n        box-sizing: border-box;\r\n        cursor: pointer;\r\n        height: 24px;\r\n        padding-top: 2px;\r\n        padding-left: 6px;\r\n        padding-right: 6px;\r\n        font-size: 15px;\r\n        position: relative;\r\n        min-width: 24px;\r\n      }\r\n\r\n      button:not([data-visible]) {\r\n        background: transparent;\r\n        border: 4px solid #fff;\r\n        box-shadow: none;\r\n        pointer-events: none;\r\n        height: 32px;\r\n        min-width: 32px;\r\n      }\r\n\r\n      button:focus {\r\n        border: 4px solid rgb(0, 128, 200);\r\n        height: 32px;\r\n        outline: none;\r\n        min-width: 32px;\r\n      }\r\n\r\n      button:focus .HotspotAnnotation {\r\n        transition: opacity 0.3s;\r\n        opacity: 1;\r\n      }\r\n\r\n      button .HotspotAnnotation {\r\n        opacity: 0;\r\n        pointer-events: none;\r\n      }\r\n\r\n      .HotspotAnnotation {\r\n        background: rgb(0, 0, 0, 0.8);\r\n        border-radius: 4px;\r\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.25);\r\n        color: rgba(0, 0, 0, 0.8);\r\n        display: block;\r\n        font-size: 12px;\r\n        font-weight: 200;\r\n        left: calc(100% + 1em);\r\n        max-width: 250px;\r\n        padding: 0.5em;\r\n        position: absolute;\r\n        top: 50%;\r\n        width: max-content;\r\n      }\r\n\r\n      .annotation_label {\r\n        font-size: 14px;\r\n        font-weight: 300;\r\n        text-align: center;\r\n        color: white;\r\n      }\r\n\r\n      .annotation_description {\r\n        color: white;\r\n        font-size: 12px;\r\n        font-weight: 200;\r\n        text-align: left;\r\n      }\r\n\r\n      .label_nav {\r\n        position: absolute;\r\n        left: 50%;\r\n        bottom: 10px;\r\n        padding: 6px;\r\n        transform: translate(-50%, -50%);\r\n        white-space: nowrap;\r\n        width: 200px;\r\n        background: rgb(0, 0, 0, 0.8);\r\n        border-radius: 8px;\r\n        overflow: hidden;\r\n        text-overflow: ellipsis;\r\n        text-align: center;\r\n      }\r\n\r\n      /* This keeps child nodes hidden while the element loads */\r\n      :not(:defined) > * {\r\n        display: none;\r\n      }\r\n\r\n      #download {\r\n        display: none;\r\n      }\r\n    `;\r\n  }\r\n\r\n  render() {\r\n    return html`\r\n      <a id=\"download\"></a>\r\n      <model-viewer\r\n        style=${map_style}\r\n        src=${this.src || \"\"}\r\n        skybox-image=${this.skybox_image || \"\"}\r\n        camera-controls\r\n        @click=\"${this.handleClick},\"\r\n        @camera-change=${this.cameraMoved}\r\n      >\r\n        <style>\r\n          ${this.annotations?.annotations?.map(\r\n            (i, index) => html` button[slot=\"hotspot-${i.name || \"random\"}\"] {\r\n            background: ${i.fill_color || \"#FFFFFFFF\"}; }`\r\n          )};\r\n        </style>\r\n        ${this.annotations?.annotations?.map(\r\n          (i, index) =>\r\n            html`<button\r\n              @click=${(e: Event) => {\r\n                console.log(i);\r\n                this.annotationClick(i);\r\n                e.stopPropagation();\r\n                e.preventDefault();\r\n              }}\r\n              slot=\"hotspot-${i.name || \"rand\"}\"\r\n              data-position=\"${i.position.x} ${i.position.y} ${i.position.z}\"\r\n              data-normal=\"${i.normal.x} ${i.normal.y} ${i.normal.z}\"\r\n              data-visibility-attribute=\"visible\"\r\n            >\r\n              ${index + 1}\r\n              <div class=\"HotspotAnnotation\">\r\n                <div class=\"annotation_label\">${i.name}</div>\r\n                <p class=\"annotation_description\">${i.description}</p>\r\n              </div>\r\n            </button>`\r\n        )}\r\n        <div class=\"label_nav\">\r\n          <div class=\"annotation_label\">\r\n            ${this.currentAnnotation?.name || \"Select an annotion\"}\r\n          </div>\r\n        </div>\r\n      </model-viewer>\r\n    `;\r\n  }\r\n}\r\n"]}